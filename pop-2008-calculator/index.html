<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>PoP 2008 Calculator</title>
    <link rel="icon" type="image/png" href="https://www.speedrun.com/static/theme/9wp0mv83/favicon.png?v=67ce752">
    <!-- Latest compiled and minified Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Latest compiled Bootstrap js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        html {
            background: var(--bs-gray-300);
        }

        body {
            margin: auto;
            padding: 30px;
            max-width: 980px;
        }

        td {
            padding: 10px 15px 0 0;
        }

        input[type=number] {
            width: 100px;
            margin-right: 20px;
        }
    </style>
</head>

<body>
    <h1>PoP 2008 Calculator</h1>

    <label>Select JSON file containing beams data:</label>&nbsp;
    <input type="file" id="fileInput" accept=".json">

    <br /><br />

    <label>Enter coordinates of load trigger:</label>&nbsp;
    <label for="pointX"><b>X</b></label>
    <input id="pointX" type=number step=0.001>
    <label for="pointY"><b>Y</b></label>
    <input id="pointY" type=number step=0.001>

    <br /><br />

    <button onclick="processJSON()">Process JSON</button>

    <br /><br />

    <table class="table table-striped" id="dataTable">
        <thead>
            <tr>
                <th>Beam</th>
                <th>Distance</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
    <script>
        function processJSON() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file.');
                return;
            }

            const pointX = parseFloat(document.getElementById('pointX').value);
            const pointY = parseFloat(document.getElementById('pointY').value);

            if (isNaN(pointX) || isNaN(pointY)) {
                alert('Please select load trigger coordinates.');
                return;
            }

            const reader = new FileReader();

            reader.onload = function (event) {
                const jsonData = JSON.parse(event.target.result);
                const processedData = displayTable(jsonData, pointX, pointY);
            };

            reader.readAsText(file);
        }

        function processData(data) {
            // Perform your processing on the JSON data here
            // For example, let's just stringify the JSON for demonstration
            return JSON.stringify(data, null, 2);
        }

        function displayTable(data, pointX, pointY) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            const calculatedDistances = data.map(item => {
                const { x1, y1, x2, y2 } = item;
                return {
                    x1,
                    y1,
                    x2,
                    y2,
                    distance: distanceFromLine(pointX, pointY, x1, y1, x2, y2)
                };
            });

            const filteredAndSortedData = calculatedDistances
                .filter(item => item.distance !== Infinity)
                .sort((a, b) => a.distance - b.distance);

            filteredAndSortedData.forEach(item => {
                const { x1, y1, x2, y2, distance } = item;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><pre>(${x1}, ${y1}) &#x1F82E; (${x2}, ${y2})</pre></td>
                    <td>${distance}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        function distanceFromLine(x, y, x1, y1, x2, y2) {
            const a = y2 - y1;
            const b = x1 - x2;
            const c = x2 * y1 - x1 * y2;

            const distance = (a * x + b * y + c) / Math.sqrt(a * a + b * b);

            // If distance is negative, the point is behind the line
            if (distance < 0) {
                return Infinity;
            }

            return distance;
        }

    </script>
</body>

</html>